<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <%= stylesheet_link_tag 'application', media: 'all' %>
    <%= javascript_include_tag "application" %>
    <script src="//maps.google.com/maps/api/js?v=3.18&sensor=false&client=&key=&libraries=geometry&language=&hl=&region="></script>
    <script src="//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js"></script>
    <script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/infobox/1.1.9/src/infobox_packed.js' type='text/javascript'></script>
  </head>
  <body>
    <div>
      <div class='show-map' id='multi_markers'></div>
    </div>
    <script type="text/javascript">
     handler = Gmaps.build('Google');
     var lat = <%= @free_parking_area.latitude %>
     var lon = <%= @free_parking_area.longitude %>
     var centerpoint = new google.maps.LatLng(lat, lon);

     handler.buildMap({ provider: {}, internal: {id: 'multi_markers'}}, function(){
       markers = handler.addMarkers(<%= raw @json_fpa.to_json %>);
       if(navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(displayOnMap)
        };

       handler.map.centerOn(centerpoint)
       handler.getMap().setZoom(16);

       function displayOnMap(position){
          handler.addMarker({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
        };
        
       var map = handler.getMap()
       var count=2
       google.maps.event.addListener(map, 'mousedown', function(event){

           var counter=setInterval(timer, 1000);
           var latLng=event.latLng;
           var contentString= '<%= link_to "Add Parking Area", free_parking_areas_path(latLng), method: :post, id: "pass_latLng"%>'
           var infowindow = new google.maps.InfoWindow({
             content: contentString
             });

             google.maps.event.addListener(map, 'mouseup', function(event){
               clearInterval(counter);
             });

           function timer(){
             count=count-1;
             if (count <= 0)
             {
                var marker = new google.maps.Marker({
                   position: latLng,
                   map: map,
                   title: "Unsaved Marker"
                 });

                 marker.addListener("click", function(){
                   infowindow.open(map, marker);
                 });
                return;
             }
           }
       });
     });
     </script>
  </body>
</html>
